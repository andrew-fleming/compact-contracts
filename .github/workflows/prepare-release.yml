name: Update version on new release branch

on:
  create:

permissions:
  contents: write
  pull-requests: write

jobs:
  update_version:
    if: github.ref_type == 'branch' && startsWith(github.ref, 'refs/heads/release-v')
    runs-on: ubuntu-latest

    env:
      COMPACT_INSTALLER_URL: ${{ vars.COMPACT_INSTALLER_URL }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Extract current version
      run: |
        CURRENT_VERSION=$(node -p "require('./contracts/package.json').version")
        echo "CURRENT_VERSION=$CURRENT_VERSION" >> "$GITHUB_ENV"

    - name: Extract new version number
      run: echo "NEW_VERSION=${GITHUB_REF#refs/heads/release-v}" >> "$GITHUB_ENV"

    - name: Replace version in files
      run: |
        echo "Current version: $CURRENT_VERSION"
        echo "New version: $NEW_VERSION"

        # Update package.json version field manually
        cd contracts
        node -e "
          const fs = require('fs');
          const pkg = require('./package.json');
          pkg.version = '$NEW_VERSION';
          fs.writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          console.log('Updated package.json to version $NEW_VERSION');
        "
        # Update yarn.lock to reflect the new version
        yarn install
        cd ..

        # Escape special characters for sed
        ESCAPED_CURRENT=$(printf '%s' "$CURRENT_VERSION" | sed -e 's/[\/&]/\\&/g')
        ESCAPED_NEW=$(printf '%s' "$NEW_VERSION" | sed -e 's/[\/&]/\\&/g')

        # Replace version in contracts/src/
        find ./contracts/src/ -type d -name '.*' -prune -o \
          -type f -exec sed -i "s#$ESCAPED_CURRENT#$ESCAPED_NEW#g" {} +

        # Replace version in docs/, excluding package-lock.json
        find ./docs/ -type d -name '.*' -prune -o \
          -type f ! -name 'package-lock.json' -exec sed -i "s#$ESCAPED_CURRENT#$ESCAPED_NEW#g" {} +

    - name: Auto-commit changes
      uses: stefanzweifel/git-auto-commit-action@778341af668090896ca464160c2def5d1d1a3eb0 #v6.0.1
      with:
        commit_message: Bump version to ${{ env.NEW_VERSION }}
