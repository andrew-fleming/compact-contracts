name: Publish Package on Release

on:
  release:
    types: [published]

jobs:
  publish:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Environment
        uses: ./.github/actions/setup

      - name: Build contracts
        run: turbo build

      - name: Validate version consistency
        run: |
          RELEASE_VERSION=${GITHUB_REF#refs/tags/v}
          PACKAGE_VERSION=$(node -p "require('./contracts/package.json').version")
          if [ "$RELEASE_VERSION" != "$PACKAGE_VERSION" ]; then
            echo "‚ùå Version mismatch: Release $RELEASE_VERSION vs Package $PACKAGE_VERSION"
            exit 1
          fi
          echo "‚úÖ Version consistency validated: $RELEASE_VERSION"

      - name: Setup npm registry
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          registry-url: "https://registry.npmjs.org"

      - name: Pack tarball
        id: pack
        run: |
          cd contracts/dist
          TARBALL=$(npm pack | tail -1)
          echo "tarball_name=$TARBALL" >> $GITHUB_OUTPUT
          echo "tarball=$(pwd)/$TARBALL" >> $GITHUB_OUTPUT

          # Determine dist-tag based on semver prerelease
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          if [[ "$PACKAGE_VERSION" =~ -.*$ ]]; then
            # Has prerelease suffix (anything after -)
            if [[ "$PACKAGE_VERSION" =~ -(alpha|beta|rc) ]]; then
              echo "tag=beta" >> $GITHUB_OUTPUT
            else
              echo "tag=next" >> $GITHUB_OUTPUT
            fi
          else
            # Stable release
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi

      - name: Verify tarball integrity
        run: |
          echo "=== Verifying tarball contents ==="
          PACKAGE_NAME=$(tar xfO "${{ steps.pack.outputs.tarball }}" package/package.json | jq -r .name)
          PACKAGE_VERSION=$(tar xfO "${{ steps.pack.outputs.tarball }}" package/package.json | jq -r .version)
          PRIVATE_FIELD=$(tar xfO "${{ steps.pack.outputs.tarball }}" package/package.json | jq -r '.private // "not found"')

          echo "üì¶ Package: $PACKAGE_NAME@$PACKAGE_VERSION"
          echo "üè∑Ô∏è  Tag: ${{ steps.pack.outputs.tag }}"
          echo "üîí Private field: $PRIVATE_FIELD"

          # Ensure no private field
          if [ "$PRIVATE_FIELD" = "true" ]; then
            echo "‚ùå Tarball contains private: true - cannot publish"
            exit 1
          fi

      - name: Publish to npm
        run: |
          # Publish the tarball with appropriate tag
          npm publish "${{ steps.pack.outputs.tarball }}" --tag "${{ steps.pack.outputs.tag }}" --access public
        env:
          NPM_CONFIG_PROVENANCE: true

      - name: Log success
        run: |
          PACKAGE_NAME=$(tar xfO "${{ steps.pack.outputs.tarball }}" package/package.json | jq -r .name)
          PACKAGE_VERSION=$(tar xfO "${{ steps.pack.outputs.tarball }}" package/package.json | jq -r .version)
          echo "‚úÖ Successfully published $PACKAGE_NAME@$PACKAGE_VERSION to npm with tag ${{ steps.pack.outputs.tag }}"
          echo "üì¶ Install with: npm install $PACKAGE_NAME@${{ steps.pack.outputs.tag }}"
